# -*- coding: utf-8 -*-
"""Agente.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/13qIZdJzkR3kwhoi4Ku71-dtQekV5a_xI
"""



import streamlit as st
import google.generativeai as genai
from PIL import Image
import io

# ------------------------------
# CONFIG DE GOOGLE API KEY
# ------------------------------
genai.configure(api_key="AIzaSyAbzZHK_i2U0u0CwEmpLqTndGXcc6TKbYE")

# ------------------------------
# MODELO
# ------------------------------
model = genai.GenerativeModel(model_name="models/gemini-2.5-flash")

# ------------------------------
# INTERFAZ
# ------------------------------
st.set_page_config(page_title="Nutri-Asistente IA", layout="centered")
st.title("üß† Nutri-Asistente Multimodal IA")
st.write("Sube tu estudio cl√≠nico + platillo + descripci√≥n de tu caso cl√≠nico con tus metas y obt√©n un an√°lisis personalizado.")

# Para simular conversaci√≥n tipo ChatGPT
if "messages" not in st.session_state:
    st.session_state.messages = []

# Mostrar historial de mensajes
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# ----------------------------------------
# PRIMER MENSAJE DEL ASISTENTE
# ----------------------------------------
if len(st.session_state.messages) == 0:
    st.session_state.messages.append({
        "role": "assistant",
        "content": "üëã Hola, soy tu asistente de salud y nutrici√≥n. Para comenzar:\n1) ¬øCu√°l es tu edad, estatura y peso?\n2) ¬øTienes antecedentes como diabetes, hipertensi√≥n, colesterol alto o alguna otra enfermedad cr√≥nica?\n1) 3)Explica tu caso clinico y metas en salud por esta consulta?"
    })
    with st.chat_message("assistant"):
        st.write(st.session_state.messages[-1]["content"])

# ----------------------------------------
# INPUT DEL USUARIO
# ----------------------------------------
user_input = st.chat_input("Escribe tu respuesta...")

if user_input:
    # Guardar mensaje
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.write(user_input)


# ----------------------------------------------------------
# PASO 1: EL ASISTENTE PIDE LA IMAGEN DEL ESTUDIO CL√çNICO (opcional)
# ----------------------------------------------------------

# Mostrar mensaje del asistente solo si no se ha mostrado
if "info_ok" not in st.session_state and len(st.session_state.messages) >= 2:
    st.session_state.info_ok = True
    with st.chat_message("assistant"):
        st.write(
            "Perfecto. Antes de continuar, necesitamos algunos datos tuyos. "
            "Una vez que los env√≠es, podr√°s subir tu estudio cl√≠nico (opcional)."
        )

# Revisar si el usuario ya respondi√≥ al mensaje anterior
last_user_message = None
for msg in reversed(st.session_state.messages):
    if msg["role"] == "user":
        last_user_message = msg["content"]
        break

# Solo mostrar uploader y bot√≥n si el usuario ya dio la entrada
if last_user_message and "study_uploaded" not in st.session_state:
    with st.chat_message("assistant"):
        st.write(
            "Ahora, si tienes un estudio cl√≠nico, **puedes subir la imagen o PDF (opcional).** "
            "Si no, puedes continuar sin subirlo."
        )

    # Subida opcional de estudio cl√≠nico
    image1 = st.file_uploader(
        "Sube tu estudio cl√≠nico (opcional)", type=["jpg", "jpeg", "png"], key="study_uploader"
    )

    # Bot√≥n para continuar si no se desea subir
    skip_upload = st.button("Continuar sin subir estudio cl√≠nico")

    if image1 or skip_upload:
        st.session_state.study_uploaded = True
        if image1:
            st.session_state.image1_bytes = image1.read()
            with st.chat_message("assistant"):
                st.write(
                    "Gracias. Ahora sube la **imagen del platillo** que deseas analizar."
                )
        else:
            with st.chat_message("assistant"):
                st.write(
                    "No se subi√≥ estudio cl√≠nico. Por favor espera...."
                )

        st.session_state.messages.append({
            "role": "assistant",
            "content": "Ahora sube la imagen del platillo."
        })

# ----------------------------------------------------------
# USO SEGURO DE image1_bytes M√ÅS ADELANTE
# ----------------------------------------------------------
# Ejemplo de c√≥mo acceder sin error:
if "image1_bytes" in st.session_state:
    image_data = {"mime_type": "image/jpeg", "data": st.session_state.image1_bytes}
else:
    image_data = None  # manejar caso cuando no se subi√≥ estudio




# ----------------------------------------------------------
# PASO 2: EL ASISTENTE PIDE LA IMAGEN DEL PLATILLO
# ----------------------------------------------------------
image2 = None
if "study_uploaded" in st.session_state:
    image2 = st.file_uploader("Sube tu platillo", type=["jpg", "jpeg", "png"], key="food_uploader")
# ----------------------------------------------------------
# PASO 3: LLAMADA AL MODELO
# ----------------------------------------------------------
if image2 and "done" not in st.session_state:
    st.session_state.done = True
    image2_bytes = image2.read()

    # Imagen opcional del estudio cl√≠nico
    imagen_estudio = None
    if "image1_bytes" in st.session_state:
        imagen_estudio = {"mime_type": "image/jpeg", "data": st.session_state.image1_bytes}

    # Imagen del platillo (siempre existe)
    imagen_platillo = {"mime_type": "image/jpeg", "data": image2_bytes}

     # -----------------------
    # EXTRAER DATOS DEL USUARIO
    # -----------------------
    user_data = "\n".join([msg["content"] for msg in st.session_state.messages if msg["role"]=="user"])

    # Prompt como texto plano (no incluir diccionarios)
    prompt = f"""
    
SISTEMA:
Eres un asistente multimodal experto en salud y nutrici√≥n. Analiza el estudio cl√≠nico si existe y el platillo, y produce un reporte detallado en base al caso clinico que el usuario cuente, metas y demas.

USUARIO:
{user_data}
(A) Imagen del estudio cl√≠nico: opcional
(B) Imagen del platillo: siempre proporcionada

TAREAS:
1) Analizar cada entrada por separado y en conjunto.
2) Invocar internamente a varios "expertos" especializados (Nutrici√≥n, Cardiolog√≠a, Endocrinolog√≠a, Medicina Interna, y un Calculador de Porciones) que emitan su an√°lisis independiente personalizado para las metas del usuario si es que las proporciono y una conclusi√≥n breve con una puntuaci√≥n de confianza (0-100).
3) Aplicar un paso de SELF-CONSISTENCY: pedir a cada experto que reconsidere su respuesta 3 veces con peque√±as variaciones en el razonamiento; agregar una votaci√≥n/consenso entre las respuestas y calcular la conclusi√≥n final y el intervalo de confianza.
4) Producir una respuesta final clara, accionable y estructurada para el usuario final, con:
   - Diagn√≥stico/observaciones clave del estudio cl√≠nico (A)
   - Identificaci√≥n del platillo y estimaci√≥n de porciones/calor√≠as (B)
   - Breve descripci√≥n nutricional (macros principales)
   - Recomendaci√≥n personalizada basada en el historial cl√≠nico (riesgo de diabetes, l√≠pidos, hipertensi√≥n, etc.)
   - Cambios sugeridos al platillo (qu√© aumentar/reducir y por qu√©)
   - Riesgos o contraindicaciones urgentes (si aplica) y se√±alamiento de cu√°ndo consultar a un profesional en persona
   - Puntuaci√≥n de confianza global y desglose por experto
   - Si falta informaci√≥n cr√≠tica, una lista de preguntas concretas para obtenerla

RESTRICCIONES:
- No asumas diagn√≥sticos definitivos; usa lenguaje de probabilidad.
- Si el contenido indica peligro inmediato, indica ‚ÄúBuscar atenci√≥n m√©dica urgente‚Äù.
- Referencias solo si se piden.


USUARIO:
(A) Imagen del estudio cl√≠nico: opcional
(B) Imagen del platillo: siempre proporcionada

TAREAS:
1. Resumen r√°pido personalizado tomando en cuenta las metricas en todos los analisis,en todos los puntos dadas al inicio por el usuario.
2. Hallazgos clave.
3. Identificaci√≥n del platillo + porci√≥n + calor√≠as + cantidad de fibra.
4. Recomendaci√≥n diet√©tica personalizada (tomar en cuenta IMC, tambien cantidades recomendadas).
5. Cambios sugeridos al platillo.
6. Puntuaciones por experto y analisis por experto.
7. Conclusi√≥n final + preguntas pendientes.

ENTREGABLE:
Responde √∫nicamente con un texto claro y estructurado para el usuario. 
NO incluyas JSON, NO incluyas formato de datos, NO incluyas listas tipo JSON.
Solo texto natural en lenguaje humano, bien explicado y organizado.


DISCLAIMER: No sustituye una consulta m√©dica.
"""


    # Construir lista de inputs
    inputs = [prompt]
    if imagen_estudio is not None:
        inputs.append(imagen_estudio)
    inputs.append(imagen_platillo)

    response = model.generate_content(inputs)

    # Mostrar mensaje de espera
    with st.chat_message("assistant"):
        st.write("üß† Analizando tus im√°genes, por favor espera...")

    # Llamada al modelo
    response = model.generate_content(inputs)

    # Mostrar respuesta final tipo chat
    with st.chat_message("assistant"):
        st.write("**Imagen del platillo:**")
        st.image(image2_bytes, use_column_width=True)  # imagen centrada
        st.write("### 1. Resumen r√°pido personalizado...")
        st.write(response.text)

    # Guardar en historial
    st.session_state.messages.append({"role": "assistant", "content": response.text})
