# -*- coding: utf-8 -*-
"""Agente.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/13qIZdJzkR3kwhoi4Ku71-dtQekV5a_xI
"""



import streamlit as st
import google.generativeai as genai
from PIL import Image
import io

# ------------------------------
# CONFIG DE GOOGLE API KEY
# ------------------------------
genai.configure(api_key="AIzaSyAbzZHK_i2U0u0CwEmpLqTndGXcc6TKbYE")

#genai.configure(api_key=st.secrets["AIzaSyAvceZtL7I0ZEwurKtDkePN2Dj77xcDfZ4"])

# ------------------------------
# MODELO
# ------------------------------
model = genai.GenerativeModel(model_name="models/gemini-2.5-flash")

# ------------------------------
# INTERFAZ
# ------------------------------
st.set_page_config(page_title="Nutri-Asistente IA", layout="centered")
st.title("üß† Nutri-Asistente Multimodal IA")
st.write("Sube tu estudio cl√≠nico + platillo y obt√©n un an√°lisis personalizado.")

# Para simular conversaci√≥n tipo ChatGPT
if "messages" not in st.session_state:
    st.session_state.messages = []

# Mostrar historial de mensajes
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# ----------------------------------------
# PRIMER MENSAJE DEL ASISTENTE
# ----------------------------------------
if len(st.session_state.messages) == 0:
    st.session_state.messages.append({
        "role": "assistant",
        "content": "üëã Hola, soy tu asistente de salud y nutrici√≥n. Para comenzar:\n1) ¬øCu√°l es tu edad?\n2) ¬øTienes antecedentes como diabetes, hipertensi√≥n o colesterol alto?"
    })
    with st.chat_message("assistant"):
        st.write(st.session_state.messages[-1]["content"])

# ----------------------------------------
# INPUT DEL USUARIO
# ----------------------------------------
user_input = st.chat_input("Escribe tu respuesta...")

if user_input:
    # Guardar mensaje
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.write(user_input)


# ----------------------------------------------------------
# PASO 1: EL ASISTENTE PIDE LA IMAGEN DEL ESTUDIO CL√çNICO
# ----------------------------------------------------------
if "info_ok" not in st.session_state and len(st.session_state.messages) >= 2:
    st.session_state.info_ok = True
    with st.chat_message("assistant"):
        st.write("Perfecto. Ahora por favor **sube la imagen de tu estudio cl√≠nico (foto o PDF en imagen).**")

# Subida de estudio cl√≠nico
image1 = st.file_uploader("Sube tu estudio cl√≠nico", type=["jpg", "jpeg", "png"], key="study_uploader")

if image1 and "study_uploaded" not in st.session_state:
    st.session_state.study_uploaded = True
    st.session_state.image1_bytes = image1.read()
    st.session_state.messages.append({"role": "assistant", "content": "Gracias. Ahora sube la **imagen del platillo** que deseas analizar."})
    with st.chat_message("assistant"):
        st.write("Gracias. Ahora sube la **imagen del platillo** que deseas analizar.")

# ----------------------------------------------------------
# PASO 2: EL ASISTENTE PIDE LA IMAGEN DEL PLATILLO
# ----------------------------------------------------------
image2 = None
if "study_uploaded" in st.session_state:
    image2 = st.file_uploader("Sube tu platillo", type=["jpg", "jpeg", "png"], key="food_uploader")

# ----------------------------------------------------------
# PASO 3: LLAMADA AL MODELO
# ----------------------------------------------------------
if image2 and "done" not in st.session_state:
    st.session_state.done = True
    image2_bytes = image2.read()

    # Tu prompt EXACTO
    prompt = """
SISTEMA:
Eres un asistente multimodal experto en salud y nutrici√≥n. Cuando recibas: (A) imagen de estudios cl√≠nicos de sangre y/o historial cl√≠nico en texto que no es obligatorio subir preguntar si se subira y (B) imagen de un platillo, debes:

1) Analizar cada entrada por separado y en conjunto.
2) Invocar internamente a varios "expertos" especializados (Nutrici√≥n, Cardiolog√≠a, Endocrinolog√≠a, Medicina Interna, y un Calculador de Porciones) que emitan su an√°lisis independiente y una conclusi√≥n breve con una puntuaci√≥n de confianza (0-100).
3) Aplicar un paso de SELF-CONSISTENCY: pedir a cada experto que reconsidere su respuesta 3 veces con peque√±as variaciones en el razonamiento; agregar una votaci√≥n/consenso entre las respuestas y calcular la conclusi√≥n final y el intervalo de confianza.
4) Producir una respuesta final clara, accionable y estructurada para el usuario final, con:
   - Diagn√≥stico/observaciones clave del estudio cl√≠nico (A)
   - Identificaci√≥n del platillo y estimaci√≥n de porciones/calor√≠as (B)
   - Breve descripci√≥n nutricional (macros principales)
   - Recomendaci√≥n personalizada basada en el historial cl√≠nico (riesgo de diabetes, l√≠pidos, hipertensi√≥n, etc.)
   - Cambios sugeridos al platillo (qu√© aumentar/reducir y por qu√©)
   - Riesgos o contraindicaciones urgentes (si aplica) y se√±alamiento de cu√°ndo consultar a un profesional en persona
   - Puntuaci√≥n de confianza global y desglose por experto
   - Si falta informaci√≥n cr√≠tica, una lista de preguntas concretas para obtenerla

RESTRICCIONES:
- No asumas diagn√≥sticos definitivos; usa lenguaje de probabilidad.
- Si el contenido indica peligro inmediato, indica ‚ÄúBuscar atenci√≥n m√©dica urgente‚Äù.
- Referencias solo si se piden.


USUARIO:
(A) Imagen del estudio cl√≠nico: {imagen_estudio}
(B) Imagen del platillo: {imagen_platillo}

TAREAS:
1. Resumen r√°pido.
2. Hallazgos clave.
3. Identificaci√≥n del platillo + porci√≥n + calor√≠as + cantidad de fibra.
4. Recomendaci√≥n diet√©tica personalizada (tomar en cuenta IMC, tambien cantidades recomendadas).
5. Cambios sugeridos al platillo.
6. Puntuaciones por experto y analisis por experto.
7. Conclusi√≥n final + preguntas pendientes.

ENTREGABLE:
Responde √∫nicamente con un texto claro y estructurado para el usuario. 
NO incluyas JSON, NO incluyas formato de datos, NO incluyas listas tipo JSON.
Solo texto natural en lenguaje humano, bien explicado y organizado.


DISCLAIMER: No sustituye una consulta m√©dica.
"""

    with st.chat_message("assistant"):
        st.write("üß† Analizando tus im√°genes, por favor espera...")

    # Llamada al modelo
    response = model.generate_content(
        [
            prompt,
            {"mime_type": "image/jpeg", "data": st.session_state.image1_bytes},
            {"mime_type": "image/jpeg", "data": image2_bytes}
        ]
    )

    # Mostrar respuesta final tipo chat
    with st.chat_message("assistant"):
        st.write(response.text)

    st.session_state.messages.append({"role": "assistant", "content": response.text})
